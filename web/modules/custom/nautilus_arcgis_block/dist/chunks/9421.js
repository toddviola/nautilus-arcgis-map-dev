"use strict";(self.webpackChunkarcgis_map_test=self.webpackChunkarcgis_map_test||[]).push([[9421],{73236:(e,t,i)=>{i.d(t,{w:()=>o});var n=i(16291),a=i(40802),s=i(85979);class o{constructor(e=9,t){this._compareMinX=d,this._compareMinY=p,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),_.prune(),x.prune(),b.prune(),T.prune()}all(e){this._all(this._data,e)}search(e,t){let i=this._data;const n=this._toBBox;if(g(e,i))for(_.clear();i;){for(let a=0,s=i.children.length;a<s;a++){const s=i.children[a],o=i.leaf?n(s):s;g(e,o)&&(i.leaf?t(s):f(e,o)?this._all(s,t):_.push(s))}i=_.pop()}}collides(e){let t=this._data;const i=this._toBBox;if(!g(e,t))return!1;for(_.clear();t;){for(let n=0,a=t.children.length;n<a;n++){const a=t.children[n],s=t.leaf?i(a):a;if(g(e,s)){if(t.leaf||f(e,s))return!0;_.push(a)}}t=_.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new k([]),this}remove(e){if(!e)return this;let t,i=this._data,a=null,s=0,o=!1;const r=this._toBBox(e);for(b.clear(),T.clear();i||b.length>0;){if(i||(i=b.pop(),a=b.data[b.length-1],s=T.pop()??0,o=!0),i.leaf&&(t=(0,n.qh)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),b.push(i),this._condense(b),this;o||i.leaf||!f(i,r)?a?(s++,i=a.children[s],o=!1):i=null:(b.push(i),T.push(s),s=0,a=i,i=i.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_all(e,t){let i=e;for(x.clear();i;){if(!0===i.leaf)for(const e of i.children)t(e);else x.pushArray(i.children);i=x.pop()??null}}_build(e,t,i,n){const a=i-t+1;let s=this._maxEntries;if(a<=s){const n=new k(e.slice(t,i+1));return r(n,this._toBBox),n}n||(n=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/s**(n-1)));const o=new C([]);o.height=n;const h=Math.ceil(a/s),l=h*Math.ceil(Math.sqrt(s));M(e,t,i,l,this._compareMinX);for(let a=t;a<=i;a+=l){const t=Math.min(a+l-1,i);M(e,a,t,h,this._compareMinY);for(let i=a;i<=t;i+=h){const a=Math.min(i+h-1,t);o.children.push(this._build(e,i,a,n-1))}}return r(o,this._toBBox),o}_chooseSubtree(e,t,i,n){for(;n.push(t),!0!==t.leaf&&n.length-1!==i;){let i,n=1/0,a=1/0;for(let s=0,o=t.children.length;s<o;s++){const o=t.children[s],r=u(o),h=y(e,o)-r;h<a?(a=h,n=r<n?r:n,i=o):h===a&&r<n&&(n=r,i=o)}t=i||t.children[0]}return t}_insert(e,t,i){const n=this._toBBox,a=i?e:n(e);b.clear();const s=this._chooseSubtree(a,this._data,t,b);for(s.children.push(e),l(s,a);t>=0&&b.data[t].children.length>this._maxEntries;)this._split(b,t),t--;this._adjustParentBBoxes(a,b,t)}_split(e,t){const i=e.data[t],n=i.children.length,a=this._minEntries;this._chooseSplitAxis(i,a,n);const s=this._chooseSplitIndex(i,a,n);if(!s)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const o=i.children.splice(s,i.children.length-s),h=i.leaf?new k(o):new C(o);h.height=i.height,r(i,this._toBBox),r(h,this._toBBox),t?e.data[t-1].children.push(h):this._splitRoot(i,h)}_splitRoot(e,t){this._data=new C([e,t]),this._data.height=e.height+1,r(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let n,a,s;n=a=1/0;for(let o=t;o<=i-t;o++){const t=h(e,0,o,this._toBBox),r=h(e,o,i,this._toBBox),l=m(t,r),d=u(t)+u(r);l<n?(n=l,s=o,a=d<a?d:a):l===n&&d<a&&(a=d,s=o)}return s}_chooseSplitAxis(e,t,i){const n=e.leaf?this._compareMinX:d,a=e.leaf?this._compareMinY:p;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,a)&&e.children.sort(n)}_allDistMargin(e,t,i,n){e.children.sort(n);const a=this._toBBox,s=h(e,0,t,a),o=h(e,i-t,i,a);let r=c(s)+c(o);for(let n=t;n<i-t;n++){const t=e.children[n];l(s,e.leaf?a(t):t),r+=c(s)}for(let n=i-t-1;n>=t;n--){const t=e.children[n];l(o,e.leaf?a(t):t),r+=c(o)}return r}_adjustParentBBoxes(e,t,i){for(let n=i;n>=0;n--)l(t.data[n],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const a=e.data[t-1],s=a.children;s.splice((0,n.qh)(s,i,s.length,a.indexHint),1)}else this.clear();else r(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function r(e,t){h(e,0,e.children.length,t,e)}function h(e,t,i,n,a){a||(a=new k([])),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let s,o=t;o<i;o++)s=e.children[o],l(a,e.leaf?n(s):s);return a}function l(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function d(e,t){return e.minX-t.minX}function p(e,t){return e.minY-t.minY}function u(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function c(e){return e.maxX-e.minX+(e.maxY-e.minY)}function y(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const i=Math.max(e.minX,t.minX),n=Math.max(e.minY,t.minY),a=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,a-i)*Math.max(0,s-n)}function f(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function M(e,t,i,n,a){const o=[t,i];for(;o.length;){const t=o.pop(),i=o.pop();if(t-i<=n)continue;const r=i+Math.ceil((t-i)/n/2)*n;(0,s.q)(e,r,i,t,a),o.push(i,r,r,t)}}const _=new a.A,x=new a.A,b=new a.A,T=new a.A({deallocator:void 0});class w{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class L extends w{constructor(){super(...arguments),this.height=1,this.indexHint=new n.vW}}class k extends L{constructor(e){super(),this.children=e,this.leaf=!0}}class C extends L{constructor(e){super(),this.children=e,this.leaf=!1}}},79141:(e,t,i)=>{i.d(t,{Hq:()=>T,Qj:()=>L,V2:()=>m,m_:()=>f});i(22333);var n=i(10590),a=i(57116),s=i(97540),o=i(54413),r=i(36483),h=i(85633),l=i(68517),d=i(86041);const p=new Float64Array(2),u=new Float64Array(2),c="0123456789bcdefghjkmnpqrstuvwxyz",y=64;function m(e,t,i,n){const r=[e.xmin,e.ymin,e.xmax,e.ymax],p=s.A.fromExtent(a.A.fromBounds(r,n)),u=(0,d.Cv)(p,n,o.A.WGS84,{densificationStep:t*y});if(!u)return null;const c=(0,h.Ye)(new l.A,u,!1,!1),m=c.coords.filter(((e,t)=>!(t%2))),g=c.coords.filter(((e,t)=>t%2)),M=Math.min(...m),_=Math.min(...g),x=Math.max(...m),b=Math.max(...g),T=f(M,_,i,o.A.WGS84),w=f(x,b,i,o.A.WGS84);return T&&w?{bounds:r,geohashBounds:{xLL:T[0],yLL:T[1],xTR:w[0],yTR:w[1]},level:i}:null}function f(e,t,i,a){if(a.isWebMercator){const a=(0,n.KJ)(e/r.$O.radius),s=a-360*Math.floor((a+180)/360),o=[0,0];return w(o,0,(0,n.KJ)(Math.PI/2-2*Math.atan(Math.exp(-t/r.$O.radius))),s,i),o}const s=(0,d.Cv)({x:e,y:t},a,o.A.WGS84);if(!s)return null;const h=[0,0];return w(h,0,s.y,s.x,i),h}function g(e){return c[e]}function M(e){return(e[0]+e[1])/2}function _(e,t,i){return e[0]=t,e[1]=i,e}function x(e,t){const i=M(e),n=t,a=!t;e[0]=a*e[0]+n*i,e[1]=a*i+n*e[1]}function b(e,t){const i=t>M(e);return x(e,i),i}function T(e,t){let i=-90,n=90,a=-180,s=180;for(let o=0;o<t;o++){const t=Math.ceil((o+1)/2),r=Math.floor((o+1)/2),h=1-o%2,l=30-(3*t+2*r),d=30-(2*t+3*r),p=3*h+2*(1-h),u=2*h+3*(1-h),c=3*h+7*(1-h)<<d,y=(7*h+3*(1-h)<<l&e.geohashX)>>l,m=(c&e.geohashY)>>d;for(let e=p-1;e>=0;e--){const t=(a+s)/2,i=y&1<<e?1:0;a=(1-i)*a+i*t,s=(1-i)*t+i*s}for(let e=u-1;e>=0;e--){const t=(i+n)/2,a=m&1<<e?1:0;i=(1-a)*i+a*t,n=(1-a)*t+a*n}}return[a,i,s,n]}function w(e,t,i,n,a){a%2&&(a+=1);let s=0,o=0,r=-90,h=90,l=-180,d=180;for(let e=0;e<a/2;e++){for(let t=0;t<5;t++){const i=(l+d)/2,a=n>i?1:0;s|=a<<29-(t+5*e),l=(1-a)*l+a*i,d=(1-a)*i+a*d}for(let t=0;t<5;t++){const n=(r+h)/2,a=i>n?1:0;o|=a<<29-(t+5*e),r=(1-a)*r+a*n,h=(1-a)*n+a*h}}e[2*t]=s,e[2*t+1]=o}function L(e,t,i){let n="";const a=_(p,-90,90),s=_(u,-180,180);for(let o=0;o<i;o++){let i=0;o%2?(i|=b(a,e)<<4,i|=b(s,t)<<3,i|=b(a,e)<<2,i|=b(s,t)<<1,i|=b(a,e)|0):(i|=b(s,t)<<4,i|=b(a,e)<<3,i|=b(s,t)<<2,i|=b(a,e)<<1,i|=b(s,t)|0),n+=g(i)}return n}},34777:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Ae});var n=i(90252),a=(i(14309),i(76182)),s=i(51819),o=i(60249),r=i(66011),h=i(17134),l=(i(22333),i(92262),i(59585)),d=i(79141),p=i(20970),u=i(85633),c=i(68517),y=i(76881),m=i(27306),f=i(45777),g=i(97540),M=i(69575),_=i(85204),x=i(28767),b=i(67593);class T{constructor(){this._featureLookup=new Map}static getInstance(){return T.instance||(T.instance=new T),T.instance}static resetInstance(){T.instance&&(T.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const i=this.readFromStoreById(e);i&&t.push(i)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,i){const n=[];return e.forEach((e=>{if(!e?.id)return;e.properties||(e.properties=[]);let a,s=null;if(i&&e.properties[i]&&(s=(0,u.Ux)(e.properties[i])),"originId"in e&&"destinationId"in e&&(e.properties.ESRI__ORIGIN_ID=e.originId,e.properties.ESRI__DESTINATION_ID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const n=this._featureLookup.get(e.id),o=JSON.parse(JSON.stringify(Object.assign(n.attributes,e.properties)));i&&e.properties[i]&&(o[i]=(0,b.rS)(e.properties[i])),a=new x.Om(s?JSON.parse(JSON.stringify(s)):n?.geometry?JSON.parse(JSON.stringify(n.geometry)):null,o,null,e.properties[t])}else a=new x.Om(s?JSON.parse(JSON.stringify(s)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,a),n.push(a)})),n}}i(1968);var w,L=i(29989),k=i(57533);i(54413);!function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(w||(w={}));w.ELEMENTUID,w.TYPENAME;var C,I;!function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(C||(C={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(I||(I={}));var E,A,D,N;i(35051),i(78329);function v(e){if(!e.spatialReference.isWGS84)throw new s.A("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}!function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(E||(E={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(A||(A={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(D||(D={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(N||(N={}));var R=i(96328),S=i(57116);const B="ESRI__ID",G="ESRI__ORIGIN_ID",F="ESRI__DESTINATION_ID",j="ESRI__LAYOUT_GEOMETRY",O="ESRI__AGGREGATION_COUNT",P=12;let q=class extends y.A{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((i,n)=>{if("entity"===t.get(n))this.entityTypeNames.add(n);else{if("relationship"!==t.get(n))return o.A.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(n);this.relationshipTypeNames.add(n)}const a=new Map;i.members?.forEach((e=>{(0,m.tE)(this.memberIdTypeLookup,e.id,(()=>new Set)).add(n);const t=this.getById(e.id);t&&a.set(e.id,t)})),this.sublayerCaches.set(n,a)}))}addToLayer(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new s.A("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(e);i.members||(i.members=new Map),i.members.set(t,{id:t}),(0,m.tE)(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}else{const i=new Map;i.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:i}),(0,m.tE)(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}))}getById(e){return T.getInstance().readFromStoreById(e)}async getData(e,t,i){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let n;if(n=e||new R.A({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,i=this._processingCacheUpdatesLookup.get(t.objectType.name??""),a=n.outFields,s=n.geometry;let o="",r="";s&&s.extent&&(o=(0,d.Qj)(s.extent.ymin,s.extent.xmin,P),r=(0,d.Qj)(s.extent.ymax,s.extent.xmax,P)),a&&1===a.length&&a[0]===B&&"1=1"===n.where||await Promise.all(i??[]);const h=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],l=[];return h.forEach((i=>{if(this.relationshipTypeNames.has(t.objectType.name)?i.geometry=e.relationshipLinkChartDiagramLookup.get(i.attributes[t.objectIdField]):i.geometry=e.entityLinkChartDiagramLookup.get(i.attributes[t.objectIdField]),i.attributes[j]=i.geometry,o&&r){const n=e.linkChartGeohashLookup.get(i.attributes[t.objectIdField]);n?n>=o&&n<=r&&l.push(i):l.push(i)}else l.push(i)})),l}return this.retrieveDataFromService(n,t,i)}async getConnectedRecordIds(e,t){const i=[];let n="";const a=[],s=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;s.has(t)?s.get(t)?.push(e):s.set(t,[e])}})),t&&0!==t?.length){for(const e of t)n=n+e+"|";n=n.slice(0,-1)}return s.forEach(((e,s)=>{let r;r=t&&0!==t?.length?`MATCH (n:${s})-[r:${n}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${s})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const h=new Promise((t=>{(async()=>{const t=(await(0,L.executeQueryStreaming)(this.knowledgeGraph,new k.A({openCypherQuery:r,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)break;for(let e=0;e<n.length;e++){const t=n[e];i.push({id:t[0],typeName:t[1]}),i.push({id:t[2],typeName:t[3]})}}}catch(e){if("AbortError"!==e.name)throw e;o.A.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));a.push(h)})),this.refreshCacheContent(),await Promise.all(a),i}async refreshCacheContent(e,t,i,n=!0){const a=T.getInstance(),o=[],r=new Map,h=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&h.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&h.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))r.has(t)?r.get(t)?.push(e):r.set(t,[e])})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?r.set(t,null):e.members&&e.members.forEach((e=>{r.has(t)&&null!==r.get(t)?r.get(t)?.push(e.id):r.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&r.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&r.set(e.name,null)})));for(const[e,l]of r){const r=new Promise((o=>{(async()=>{const o=new Set,r=[];let d,p="",u=!1;if(t||h.get(e)?.properties?.forEach((e=>{e.name&&o.add(e.name)})),i&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&o.add(t)}if(this.entityTypeNames.has(e))p=`MATCH (n:${e}) ${l?"WHERE id(n) IN $ids ":""}return ID(n)`,o.forEach((e=>{p+=`, n.${e}`,r.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new s.A("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);u=!0,p=`MATCH ()-[n:${e}]->() ${l?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,o.forEach((e=>{p+=`, n.${e}`,r.push(e)}))}d=new k.A(l?{openCypherQuery:p,bindParameters:{ids:l}}:{openCypherQuery:p});const c=(await(0,L.executeQueryStreaming)(this.knowledgeGraph,d)).resultRowsStream.getReader();for(;;){const{done:t,value:i}=await c.read();if(t)break;const s=[];for(let e=0;e<i.length;e++){const t=i[e];let n=0,a=0;const o={properties:{}};for(o.id=t[n],n++,a++,u&&(o.originId=t[n],n++,a++,o.destinationId=t[n],n++,a++,(0,m.tE)(this.nodeConnectionsLookup,o.originId,(()=>new Set)).add(o.id),(0,m.tE)(this.nodeConnectionsLookup,o.destinationId,(()=>new Set)).add(o.id),(0,m.tE)(this.relationshipConnectionsLookup,o.id,(()=>[o.originId,o.destinationId])));n<t.length;n++)o.properties[r[n-a]]=t[n];s.push(o)}const o=a.writeToStore(s,B,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);const h=this.sublayerCaches.get(e);o.forEach((t=>{h?.set(t.attributes[B],t),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes[B])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes[B],{id:t.attributes[B]}),(0,m.tE)(this.memberIdTypeLookup,t.attributes[B],(()=>new Set)).add(e))}))}})().then((()=>{o(null)}))}));o.push(r),this._processingCacheUpdatesLookup.get(e)?.push(r)}await Promise.all(o)}removeFromLayer(e){const t=new Set,i=new Set(e.map((e=>e.id)));for(const i of e)t.add(i.typeName),1===this.memberIdTypeLookup.get(i.id)?.size?this.memberIdTypeLookup.delete(i.id):this.memberIdTypeLookup.get(i.id)?.delete(i.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===i.typeName&&e.members?.has(i.id)&&e.members.delete(i.id)}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,n)=>{i.has(n)&&this.sublayerCaches.get(e)?.delete(n)}))}))}async retrieveDataFromService(e,t,i){const n=T.getInstance(),a=new Set,o=[];let r,h="",l=[];const d="relationship"===t.graphType,p=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,u=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let c=!p&&u?Array.from(u).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(c=e.objectIds);else if(null!=e.objectIds&&c&&c.length>0){const t=e.objectIds;e.objectIds=c.filter((e=>t.includes(e)))}else if(null!=e.objectIds)c=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=c}if(null!=e.outFields){const i=e.outFields;i.includes("*")?t.fields.forEach((e=>{a.add(e.name)})):i.forEach((e=>{e!==B&&e!==t.geometryFieldName&&a.add(e)}))}if(null!=e.geometry){const i=e.geometry;let n;const l=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,p=l?.spatialReference,u=l?.serviceCapabilities?.geometryCapabilities;let c=u?.geometryMaxBoundingRectangleSizeX,y=u?.geometryMaxBoundingRectangleSizeY;if(i?.extent?.spatialReference&&!i.spatialReference?.isWGS84?(await(0,M.initializeProjection)(i.extent.spatialReference,_.KK),n=(0,M.project)(i.extent,_.KK)):n=i.extent,c&&y&&p){if(4326!==p.wkid){const e=new S.A({spatialReference:p,xmax:c,ymax:y}),t=(0,M.project)(e,_.KK);c=t.xmax,y=t.ymax}if(n.xmax-n.xmin>c)throw new s.A("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${c}° latitude, limit exceeded`);if(n.ymax-n.ymin>y)throw new s.A("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${y}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const i=await(0,f.G)(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&a.add(e.name)}))}h=d?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&a.add(t.geometryFieldName),a.forEach((e=>{h+=`, n.${e}`,o.push(e)})),r=new k.A({openCypherQuery:h,bindParameters:{param_filter_geom:new g.A({rings:v(n)})}})}else{let i="";if(null!=e.where&&"1=1"!==e.where){const n=await(0,f.G)(e.where,t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&a.add(e.name)}));const s=new Set(["column-reference","string","number","binary-expression"]),o=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let r=!1;const h=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&s.has(e.left.type)&&s.has(e.right.type)&&o.has(e.operator))return`${h(e.left)} ${e.operator} ${h(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return r=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return r=!0,"";{let i=e.right.value;"%"===i.charAt(0)&&(i=i.slice(1)),"%"===i.charAt(i.length-1)&&(i=i.slice(0,-1)),t+=`'${i.toLowerCase()}')`}return t}return r=!0,""};i=h(n.parseTree),r&&(i="")}let n="";n=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let s=!1;c&&(s=!0,n+=" WHERE ID(n) IN $ids"),i&&(n+=s?" AND":" WHERE",n+=` ${i}`),n+=" return ID(n)",d&&(n+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&a.add(t.geometryFieldName),a.forEach((e=>{n+=`, n.${e}`,o.push(e)})),r=new k.A(c?{openCypherQuery:n,bindParameters:{ids:c}}:{openCypherQuery:n})}const y=(await(0,L.executeQueryStreaming)(t.parentCompositeLayer.dataManager.knowledgeGraph,r,i)).resultRowsStream.getReader();for(;;){const{done:e,value:i}=await y.read();if(e)break;const a=[];for(let e=0;e<i.length;e++){const t=i[e];let n=0,s=0;const r={properties:{}};for(r.id=t[n],n++,s++,d&&(r.originId=t[n],n++,s++,r.destinationId=t[n],n++,s++);n<t.length;n++)r.properties[o[n-s]]=t[n];a.push(r)}l=l.concat(n.writeToStore(a,B,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return l}};(0,n._)([(0,h.MZ)()],q.prototype,"knowledgeGraph",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"inclusionModeDefinition",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"entityTypeNames",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"relationshipTypeNames",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"geographicLookup",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"sublayerCaches",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"nodeConnectionsLookup",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"relationshipConnectionsLookup",void 0),(0,n._)([(0,h.MZ)()],q.prototype,"memberIdTypeLookup",void 0),q=(0,n._)([(0,l.$)("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],q);var Z=i(22982),Y=(i(89873),i(58004),i(57215),i(36766),i(91191),i(43455),i(11905),i(81661),i(29161)),$=i(80947),Q=(i(44334),i(26698)),U=i(64050),X=i(1267);const H=(0,i(11977).p)(),J=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return(0,n._)([(0,h.MZ)(H.fields)],t.prototype,"fields",void 0),(0,n._)([(0,h.MZ)(H.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=(0,n._)([(0,l.$)("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var z=i(2095),W=i(65159),V=i(61893),K=i(33203),ee=i(53479),te=i(93540),ie=i(34639),ne=i(716),ae=i(32358),se=i(69398),oe=i(96980),re=i(56215);let he=class extends((0,W.J)(J((0,z.d)((0,K.j)((0,V.J)(p.A)))))){constructor(e){if(super(e),this.capabilities=(0,X.f)(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=B,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new se.A(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const i=R.A.fromJSON(e);return this.queryFeaturesJSON(i,t)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=j;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?re.g.fromJSON(t.geometryType):null;const i=t?.name,n=i?e.objectType.properties?.[i]:null;n?(this.hasM=n.hasM??!1,this.hasZ=n.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=e.fieldType;"esriFieldTypeOID"===t&&(t="esriFieldTypeInteger"),this.fields.push(te.A.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:null,editable:e.editable,nullable:e.nullable}))})),this.fields.push(te.A.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(te.A.fromJSON({name:O,type:"esriFieldTypeInteger",alias:O,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=(0,Y.r)((0,X.F0)(re.g.toJSON("polyline")).renderer):this.renderer=(0,Y.r)((0,X.F0)(re.g.toJSON("point")).renderer):this.renderer=(0,Y.r)((0,X.F0)(re.g.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){(0,ie.yp)(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return(0,ae.tn)(this,e)}createQuery(){return new R.A({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e),a=ne.A.fromJSON(await n.executeQuery(i.toJSON(),t?.signal));return a.features.forEach((e=>{e.sourceLayer=this})),a}async queryFeaturesJSON(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(i.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(i.toJSON(),t?.signal)}async queryExtent(e={},t){const i={...e,returnGeometry:!0},{resolvedQuery:n,queryEngine:a}=await this._setupQueryObjects(i),s=await a.executeQueryForExtent(n.toJSON(),t?.signal);let o;return o=null!=s.extent?.xmin&&null!=s.extent?.xmax&&null!=s.extent?.ymin&&null!=s.extent?.ymax?new S.A(s.extent):new S.A,{count:s.count,extent:o}}async queryObjectIds(e,t){const i=R.A.from(e);let n;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(e)}return n.executeQueryForIds(i.toJSON(),t?.signal)}loadQueryEngine(e){const t=new Q.A({geometryType:re.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new U.d({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:re.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return i.featureStore.addMany(e),i}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new R.A({where:"1=1",outFields:[B]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const i=R.A.from(e),n=i.geometry;let a;if(n&&!n.spatialReference?.isWGS84&&(await(0,M.initializeProjection)(n.spatialReference,_.KK),i.geometry=(0,M.project)(n instanceof g.A||n instanceof oe.A?n:n.extent,_.KK)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)a=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);a=this.loadQueryEngine(e)}return{resolvedQuery:i,queryEngine:a}}};(0,n._)([(0,h.MZ)()],he.prototype,"capabilities",void 0),(0,n._)([(0,h.MZ)({readOnly:!0})],he.prototype,"defaultPopupTemplate",null),(0,n._)([(0,h.MZ)()],he.prototype,"definitionExpression",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"displayField",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"elevationInfo",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"geometryType",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"geometryFieldName",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"graphType",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"hasM",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"hasZ",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"labelsVisible",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"labelingInfo",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"objectIdField",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"objectType",void 0),(0,n._)([(0,h.MZ)()],he.prototype,"parentCompositeLayer",void 0),(0,n._)([(0,h.MZ)(ee.M6)],he.prototype,"popupEnabled",void 0),(0,n._)([(0,h.MZ)({type:Z.A,json:{name:"popupInfo",write:!0}})],he.prototype,"popupTemplate",void 0),(0,n._)([(0,h.MZ)({types:$.H,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],he.prototype,"renderer",null),(0,n._)([(0,h.MZ)()],he.prototype,"source",void 0),(0,n._)([(0,h.MZ)({json:{read:!1}})],he.prototype,"type",void 0),he=(0,n._)([(0,l.$)("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],he);const le=he;var de=i(58048);let pe,ue=null;function ce(){return pe||(pe=i.e(5425).then(i.bind(i,95425)).then((e=>e.l)).then((({default:e})=>e({locateFile:e=>(0,de.s)(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{!function(e){ue=e}(e)})),pe)}var ye,me;function fe(e,t,i,n,a,s){const o=i.length,r=a.length,h=Float64Array.BYTES_PER_ELEMENT,l=Uint32Array.BYTES_PER_ELEMENT,d=Uint8Array.BYTES_PER_ELEMENT,p=15+o*(d+2*h)+r*(2*l),u=ue._malloc(p);try{const d=u+16-u%16,p=d+o*h,c=p+o*h,y=c+r*l,m=y+r*l,f=()=>[ue.HEAPF64.subarray(d>>3,(d>>3)+o),ue.HEAPF64.subarray(p>>3,(p>>3)+o),ue.HEAPU32.subarray(c>>2,(c>>2)+r),ue.HEAPU32.subarray(y>>2,(y>>2)+r),ue.HEAPU8.subarray(m,m+o)],[g,M,_,x,b]=f();g.set(i),M.set(n),_.set(a),x.set(s),b.set(t);let T=e(o,m,d,p,r,c,y),w=null;if(T){const e=ue.getLayoutLinksTypes(),t=ue.getLayoutLinksVerticesEndIndices(),i=ue.getLayoutLinksVertices(),n=ue.countLayoutLinksVertices();!r||e&&t?n&&!i?T=!1:w={types:new Uint8Array(ue.HEAPU8.subarray(e,e+r)),vertexEndIndex:new Uint32Array(ue.HEAPU32.subarray(t>>2,(t>>2)+r)),vertices:new Float64Array(ue.HEAPF64.subarray(i>>3,(i>>3)+2*n))}:T=!1}const[L,k,C,I,E]=f();return i.set(L),n.set(k),a.set(C),s.set(I),t.set(E),{success:T,links:w}}finally{ue._free(u),ue.cleanupLayout()}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(ye||(ye={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(me||(me={}));var ge,Me,_e,xe,be,Te,we,Le;!function(e){e.getMinIdealEdgeLength=function(){return ue.getMinIdealEdgeLength()},e.apply=function(e,t,i,n,a,s=2,o=1,r=-1){return fe(((e,t,i,n,a,h,l)=>ue.applyForceDirectedLayout(e,t,i,n,a,h,l,s,o,r)),e,t,i,n,a)}}(ge||(ge={})),function(e){e.apply=function(e,t,i,n,a,s=2,o=1,r=-1){return fe(((e,t,i,n,a,h,l)=>ue.applyCommunityLayout(e,t,i,n,a,h,l,s,o,r)),e,t,i,n,a)}}(Me||(Me={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applySimpleLayout,e,t,i,n,a)}}(_e||(_e={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applyHierarchicalLayout,e,t,i,n,a)}}(xe||(xe={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applyRadialTreeLayout,e,t,i,n,a)}}(be||(be={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applySmartTreeLayout,e,t,i,n,a)}}(Te||(Te={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(we||(we={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Le||(Le={}));var ke=i(67406),Ce=i(96347),Ie=i(38431);let Ee=class extends((0,z.d)((0,K.j)(p.A))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new a.A,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new S.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new a.A,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new s.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set;let i=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new s.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((a,s)=>{if(!this._graphTypeLookup.get(s))return o.A.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof Ce.A||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),n.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof ke.A||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),i.push(this._graphTypeLookup.get(s))):(o.A.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))})):(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const a=new q({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=n,this.dataManager=a}load(e){return this.addResolvingPromise(new Promise((t=>{(0,L.fetchKnowledgeGraph)(this.url).then((i=>{if(this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof c.A?e.linkChartLocation:e.linkChartLocation?(0,u.Ux)(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,(0,d.Qj)(t.coords[1],t.coords[0],P)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t))})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{(0,r.Te)(e);const t=[],i=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e,t){let i=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await async function(e,t){const i=[],n=new Map,a=[];if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&n.set(e.name,[]);for(const t of e)n.has(t.typeName)&&n.get(t.typeName)?.push(t.id);for(const[e,s]of n){if(s.length<1)continue;const n=new k.A({openCypherQuery:`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:s}});a.push((0,L.executeQueryStreaming)(t,n).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:n}=await t.read();if(e)break;for(const e of n)i.push({id:e[0],typeName:e[1]}),i.push({id:e[2],typeName:e[3]})}})))}return await Promise.all(a),i}(e,this.dataManager.knowledgeGraph));const n=e.concat(i).filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));await this._handleNewRecords(n)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let n=[];for(const t of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id)&&n.push(t);if(t){const e=new Set,t=[];for(const t of n)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(const i of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(i);for(const i of e)if(this.dataManager.memberIdTypeLookup.has(i))for(const e of this.dataManager.memberIdTypeLookup.get(i))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:i,typeName:e});n=n.concat(t)}this.dataManager.removeFromLayer(n);for(const e of n)this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);i&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const a=[];return this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine())})),await Promise.all(a),this._refreshNamedTypes(),n}async expand(e,t){const i=await this.dataManager.getConnectedRecordIds(e,t),n=i.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(i),{records:n}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new le({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new le({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const i=((e,t,i)=>(e.has(t)||e.set(t,i()),e.get(t)))(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(i.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof c.A)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,d.Qj)(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],P)):this.linkChartGeohashLookup.set(e.id,"");else{const i=(0,u.Ux)(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,(0,d.Qj)(e.linkChartLocation.x,e.linkChartLocation.y,P)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const i=[],n=[],a=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{i.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{n.push({typeName:t,feature:e})}))})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const r=new Map,h=new Map,l=new Map,p=new Map,c=new Uint8Array(i.length),y=new Float64Array(i.length),m=new Float64Array(i.length),f=new Uint32Array(n.length),g=new Uint32Array(n.length),M=[],_=new S.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let x,b="FORCE_DIRECTED",T=0,w=0;switch(b="GEOGRAPHIC"===e?"FORCE_DIRECTED":e,b){case"FORCE_DIRECTED":x=ge.apply;break;case"COMMUNITY":x=Me.apply;break;case"HIERARCHICAL":x=xe.apply;break;case"RADIAL_TREE":x=be.apply;break;case"SMART_TREE":x=Te.apply;break;default:x=_e.apply}i.forEach((({typeName:i,feature:n})=>{if(t?.lockedNodeLocations?.has(n.attributes[B])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(i)?c[T]=ye.IsGeographic:c[T]=ye.None;const a=t.lockedNodeLocations.get(n.attributes[B]);y[T]=a.x,m[T]=a.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(i)){c[T]=ye.IsGeographic;let e=null;const t=n.attributes[this.dataManager.geographicLookup.get(i).name],a=this.dataManager.geographicLookup.get(i)?.geometryType;switch(a){case"esriGeometryPoint":y[T]=t?.x,m[T]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(y[T]=e.x,m[T]=e.y):c[T]=ye.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(y[T]=e.x,m[T]=e.y):c[T]=ye.IsMovable;break;default:c[T]=ye.IsMovable}(null==y[T]||null==m[T]||Number.isNaN(y[T])||Number.isNaN(m[T]))&&(c[T]=ye.IsMovable,y[T]=0,m[T]=0)}else c[T]=ye.IsMovable,y[T]=0,m[T]=0;p.set(n.attributes[B],T),M[T]={feature:n,typeName:i},T++}));let L=!1;const k=new Map;n.forEach((e=>{const t=e.feature.attributes[G],i=e.feature.attributes[F],n=p.get(t),s=p.get(i);if(void 0!==n&&void 0!==s){const o=t+"-"+i,r=k.get(o),h=r?.has(e.typeName);h||(f[w]=n,g[w]=s,void 0===r?k.set(o,new Map([[e.typeName,w]])):r.set(e.typeName,w),w++),a.push(e)}else L=!0,this.relationshipLinkChartDiagramLookup.set(t,null),this.linkChartGeohashLookup.set(t,null)})),L&&o.A.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await ce();const{success:C,links:I}=x(c,y,m,f.subarray(0,w),g.subarray(0,w));if(!C)throw new s.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let e=0;e<M.length;e++){if(m[e]>84.9999?m[e]=84.9999:m[e]<-84.9999&&(m[e]=-84.9999),y[e]>179.9999?y[e]=179.9999:y[e]<-179.9999&&(y[e]=-179.9999),M[e].feature.attributes[j]=new Ie.A(y[e],m[e]),r.has(M[e].typeName)){const t=r.get(M[e].typeName);t?.set(M[e].feature.attributes[B],M[e].feature)}else{const t=new Map;t.set(M[e].feature.attributes[B],M[e].feature),r.set(M[e].typeName,t)}l.set(M[e].feature.attributes[B],M[e].feature);const t=(0,u.Ux)(M[e].feature.attributes[j]);this.entityLinkChartDiagramLookup.set(M[e].feature.attributes[B],M[e].feature.attributes[j]?t:null),this.linkChartGeohashLookup.set(M[e].feature.attributes[B],(0,d.Qj)(M[e].feature.attributes[j].y,M[e].feature.attributes[j].x,P)),M[e].feature.attributes[j].x<_.xmin&&(_.xmin=M[e].feature.attributes[j].x),M[e].feature.attributes[j].x>_.xmax&&(_.xmax=M[e].feature.attributes[j].x),M[e].feature.attributes[j].y<_.ymin&&(_.ymin=M[e].feature.attributes[j].y),M[e].feature.attributes[j].y>_.ymax&&(_.ymax=M[e].feature.attributes[j].y)}if(this.linkChartExtent.xmin=_.xmin,this.linkChartExtent.xmax=_.xmax,this.linkChartExtent.ymin=_.ymin,this.linkChartExtent.ymax=_.ymax,!I)throw new s.A("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const E=new Map,A=new Map,D=new Map,N=new Set;for(let e=0;e<a.length;e++){const t=[],i=a[e],n=i.feature.attributes[G],s=i.feature.attributes[F],r=n+"-"+s,d=k.get(r).get(i.typeName),c=0===d?0:I?.vertexEndIndex[d-1];if(!N.has(d)){if(N.add(d),I.types[d]===me.Recursive){const e=[I.vertices[2*c],I.vertices[2*c+1]],i=[I.vertices[2*(c+1)],I.vertices[2*(c+1)+1]],n=[.5*(e[0]+i[0]),.5*(e[1]+i[1])],a=[n[0]-e[0],n[1]-e[1]],s=[n[0]+a[1],n[1]-a[0]],o=[n[0]-a[1],n[1]+a[0]];t.push(e),t.push(s),t.push(i),t.push(o),t.push(e)}else{if(I.types[d]!==me.Regular){o.A.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let e=c;e<I.vertexEndIndex[d];e++)t.push([I.vertices[2*e],I.vertices[2*e+1]])}const e=M[p.get(n)]?.feature.attributes[j],i=M[p.get(s)]?.feature.attributes[j];t[0][0]===e.x&&t[0][1]===e.y||(t[0]=[e.x,e.y]),t[t.length-1][0]===i.x&&t[t.length-1][1]===i.y||(t[t.length-1]=[i.x,i.y]);for(let e=1;e<t.length-1;e++)t[e][1]>85.5?t[e][1]=85.5:t[e][1]<-85.5&&(t[e][1]=-85.5),t[e][0]>179.9999?t[e][0]=179.9999:t[e][0]<-179.9999&&(t[e][0]=-179.9999);E.has(r)?E.get(r).push(t):E.set(r,[t])}const y=E.get(r);A.has(r)||(A.set(r,new Map),D.set(r,new Map));const m=A.get(r),f=D.get(r);m.has(i.typeName)||(m.set(i.typeName,y.shift()),f.set(i.typeName,0));const g=m.get(i.typeName);f.set(i.typeName,f.get(i.typeName)+1);const _=new oe.A({paths:g});if(i.feature.attributes[j]=_,h.has(i.typeName)){const e=h.get(i.typeName);e?.set(i.feature.attributes[B],i.feature)}else{const e=new Map;e.set(i.feature.attributes[B],i.feature),h.set(i.typeName,e)}l.set(i.feature.attributes[B],i.feature);const x=(0,u.Ux)(i.feature.attributes[j]);this.relationshipLinkChartDiagramLookup.set(i.feature.attributes[B],i.feature.attributes[j]?x:null),this.linkChartGeohashLookup.set(i.feature.attributes[B],"")}for(const e of a)e.feature.attributes[O]=D.get(e.feature.attributes[G]+"-"+e.feature.attributes[F])?.get(e.typeName)??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:r,links:h,idMap:l}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const i=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const i=t.linkChartLocation;let n;const a=t.id;i&&(n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(a,new Ie.A({x:n.x,y:n.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const i=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!i.has(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(const e of t)if(this._graphTypeLookup.has(e)){const t=this._graphTypeLookup.get(e),i="endPoints"in t?"relationship":"entity",n=new le({objectType:t,parentCompositeLayer:this,graphType:i,title:e});"entity"===i?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),n.geometryType?this.layers.push(n):this.tables.push(n),this.dataManager.sublayerCaches.set(e,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e?.members?.forEach((e=>{const i=e.linkChartLocation;let n;const a=e.id;if(!i)return;n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const s=(0,u.Ux)(n);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a,s):this.entityLinkChartDiagramLookup.set(a,s),this.linkChartGeohashLookup.set(a,(0,d.Qj)(n.x,n.y,P)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[G]),i=this.relationshipLinkChartDiagramLookup.get(e.attributes[F]);if(t&&i){const n=(0,u.Ux)(new oe.A({paths:[[t.coords[0],t.coords[1]],[i.coords[0],i.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[B],n)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[B],null);this.linkChartGeohashLookup.set(e.attributes[B],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};(0,n._)([(0,h.MZ)()],Ee.prototype,"dataPreloadedInLocalCache",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"defaultLinkChartConfig",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"dataManager",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"knowledgeGraph",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"layers",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"entityLinkChartDiagramLookup",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"linkChartExtent",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"linkChartGeohashLookup",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"memberEntityTypes",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"memberRelationshipTypes",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"sublayerIdsCache",void 0),(0,n._)([(0,h.MZ)()],Ee.prototype,"tables",void 0),(0,n._)([(0,h.MZ)({json:{read:!1}})],Ee.prototype,"type",void 0),Ee=(0,n._)([(0,l.$)("esri.layers.LinkChartLayer")],Ee);const Ae=Ee},55527:(e,t,i)=>{i.d(t,{F:()=>h});var n=i(22333),a=i(73236),s=i(11960);const o={minX:0,minY:0,maxX:0,maxY:0};function r(e,t,i){(function(e){o.minX=e[0],o.minY=e[1],o.maxX=e[2],o.maxY=e[3]})(t),e.search(o,i)}class h{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.w(9,(0,n.A)("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((i,n)=>{e[t++]=n})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=(0,s.Ie)();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),r(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},26698:(e,t,i)=>{i.d(t,{A:()=>y});var n=i(16291),a=i(51819),s=i(45412),o=i(60249),r=i(84313),h=i(11960),l=i(85633),d=i(55527),p=i(76044),u=i(9941);const c=(0,r.vt)();class y{constructor(e){this.geometryInfo=e,this._boundsStore=new d.F,this._featuresById=new Map,this._markedIds=new Set,this.events=new s.A,this.featureAdapter=u.T}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,i,n,a]=this.fullBounds;return{xmin:t,ymin:i,xmax:n,ymax:a,spatialReference:(0,p.ag)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map((e=>this._upsert(e)));return this._emitChanged(),t.filter(n.Ru)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const i of e){const e=this._boundsStore.get(i.objectId);e&&t((0,r.Jt)(c,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,i)=>{this._markedIds.has(i)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(null==t)return void o.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new a.A("featurestore:invalid-feature","feature id is missing",{feature:e}));const i=this._featuresById.get(t);let n;if(this._markedIds.add(t),i?(e.displayId=i.displayId,n=this._boundsStore.get(t),this._boundsStore.delete(t)):null!=this.onFeatureAdd&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);n=(0,l.jQ)(null!=n?n:(0,h.vt)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=n&&this._boundsStore.set(t,n),this._featuresById.set(t,e)}_upsert(e){const t=e?.objectId;if(null==t)return o.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new a.A("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const i=this._featuresById.get(t);if(!i)return this._add(e),e;this._markedIds.add(t);const{geometry:n,attributes:s}=e;for(const e in s)i.attributes[e]=s[e];return n&&(i.geometry=n,this._boundsStore.set(t,(0,l.jQ)((0,h.vt)(),n,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),i}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._markedIds.delete(t),this._boundsStore.delete(t),this._featuresById.delete(t),e}}},1267:(e,t,i)=>{i.d(t,{F0:()=>r,Vx:()=>d,e2:()=>p,f:()=>u});var n=i(22333),a=i(95049),s=i(14897),o=i(3328);function r(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?o.Cb:"esriGeometryPolyline"===e?o.yM:o.WR}}}const h=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/;let l=1;function d(e,t){if((0,n.A)("esri-csp-restrictions"))return()=>({[t]:null,...e});try{let i=`this.${t} = null;`;for(const t in e)i+=`this${h.test(t)?`.${t}`:`["${t}"]`} = ${JSON.stringify(e[t])};`;const n=new Function(`\n      return class AttributesClass$${l++} {\n        constructor() {\n          ${i};\n        }\n      }\n    `)();return()=>new n}catch(i){return()=>({[t]:null,...e})}}function p(e={}){return[{name:"New Feature",description:"",prototype:{attributes:(0,a.o8)(e)}}]}function u(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0,supportsAsyncConvert3D:!1},query:s.F,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}},28614:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(90252),a=(i(14309),i(17134)),s=(i(22333),i(60249),i(92262),i(59585)),o=i(33327),r=i(38431);let h=class extends o.A{constructor(e){super(e),this.layoutGeometry=null}};(0,n._)([(0,a.MZ)({type:r.A,json:{write:!0}})],h.prototype,"layoutGeometry",void 0),h=(0,n._)([(0,s.$)("esri.rest.knowledgeGraph.Entity")],h);const l=h},33327:(e,t,i)=>{i.d(t,{A:()=>h});var n=i(90252),a=i(17134),s=(i(22333),i(60249),i(92262),i(59585)),o=i(81398);let r=class extends o.A{constructor(e){super(e),this.typeName=null,this.id=null}};(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],r.prototype,"typeName",void 0),(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],r.prototype,"id",void 0),r=(0,n._)([(0,s.$)("esri.rest.knowledgeGraph.GraphNamedObject")],r);const h=r},81398:(e,t,i)=>{i.d(t,{A:()=>h});var n=i(90252),a=i(62274),s=i(17134),o=(i(22333),i(60249),i(92262),i(59585));let r=class extends a.oY{constructor(e){super(e),this.properties=null}};(0,n._)([(0,s.MZ)({json:{write:!0}})],r.prototype,"properties",void 0),r=(0,n._)([(0,o.$)("esri.rest.knowledgeGraph.GraphObject")],r);const h=r},57533:(e,t,i)=>{i.d(t,{A:()=>d});var n=i(90252),a=i(17134),s=(i(22333),i(60249),i(92262),i(59585)),o=i(76881);let r=class extends o.A{constructor(e){super(e),this.openCypherQuery=""}};(0,n._)([(0,a.MZ)()],r.prototype,"openCypherQuery",void 0),r=(0,n._)([(0,s.$)("esri.rest.knowledgeGraph.GraphQuery")],r);const h=r;let l=class extends h{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null,this.outputSpatialReference=null}};(0,n._)([(0,a.MZ)()],l.prototype,"bindParameters",void 0),(0,n._)([(0,a.MZ)()],l.prototype,"bindGeometryQuantizationParameters",void 0),(0,n._)([(0,a.MZ)()],l.prototype,"outputQuantizationParameters",void 0),(0,n._)([(0,a.MZ)()],l.prototype,"outputSpatialReference",void 0),l=(0,n._)([(0,s.$)("esri.rest.knowledgeGraph.GraphQueryStreaming")],l);const d=l},5853:(e,t,i)=>{i.d(t,{A:()=>r});var n=i(90252),a=(i(60249),i(22333),i(92262),i(51819),i(59585)),s=i(81398);let o=class extends s.A{constructor(e){super(e)}};o=(0,n._)([(0,a.$)("esri.rest.knowledgeGraph.ObjectValue")],o);const r=o},68166:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(90252),a=i(62274),s=i(17134),o=(i(22333),i(60249),i(92262),i(59585)),r=i(81398);let h=class extends a.oY{constructor(e){super(e),this.path=null}};(0,n._)([(0,s.MZ)({type:[r.A],json:{write:!0}})],h.prototype,"path",void 0),h=(0,n._)([(0,o.$)("esri.rest.knowledgeGraph.Path")],h);const l=h},69603:(e,t,i)=>{i.d(t,{A:()=>l});var n=i(90252),a=(i(14309),i(17134)),s=(i(22333),i(60249),i(92262),i(59585)),o=i(33327),r=i(96980);let h=class extends o.A{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],h.prototype,"originId",void 0),(0,n._)([(0,a.MZ)({type:String,json:{write:!0}})],h.prototype,"destinationId",void 0),(0,n._)([(0,a.MZ)({type:r.A,json:{write:!0}})],h.prototype,"layoutGeometry",void 0),h=(0,n._)([(0,s.$)("esri.rest.Relationship.Relationship")],h);const l=h}}]);